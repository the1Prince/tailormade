# Deploy TailorMade on Render

## Prerequisites

- [MongoDB](https://www.mongodb.com/atlas) (e.g. Atlas) – get a connection string.
- [Render](https://render.com) account.
- Git repo with the TailorMade code (e.g. push `tailormade/` to GitHub).

---

## 1. Push the repo

If the repo root is `tailormade/` (so `render.yaml` is at the repo root):

```bash
cd d:\react\tailormade
git init
git add .
git commit -m "TailorMade initial"
git remote add origin https://github.com/YOUR_USER/YOUR_REPO.git
git push -u origin main
```

If your repo root is `d:\react` and TailorMade is in `tailormade/`, then in Render you’ll set **Root Directory** to `tailormade` when linking the repo (see step 2).

---

## 2. Create services from Blueprint

1. Go to [Render Dashboard](https://dashboard.render.com/) → **New** → **Blueprint**.
2. Connect your Git provider and select the repo.
3. If the repo root is not `tailormade/`, set **Root Directory** to `tailormade`.
4. Render will read `render.yaml` and show **tailormade-api** and **tailormade-admin**. Click **Apply**.
5. You’ll be prompted for **secret** env vars (those with `sync: false`). Add them as below before the first deploy.

---

## 3. Environment variables

### Backend (tailormade-api)

In **Dashboard → tailormade-api → Environment** set:

| Key | Value |
|----|--------|
| `MONGODB_URI` | Your MongoDB connection string (e.g. from Atlas). |
| `ADMIN_WEB_URL` | `https://tailormade-admin.onrender.com` (or your admin URL). |
| `FRONTEND_URL` | Same as `ADMIN_WEB_URL` (or your custom domain). |

`JWT_SECRET` is auto-generated by the Blueprint; leave it unless you need a fixed value.

### Admin (tailormade-admin)

| Key | Value |
|----|--------|
| `VITE_API_URL` | Backend API base URL, e.g. `https://tailormade-api.onrender.com/api`. |

Use your real backend URL (with `/api` at the end). Render gives the backend URL after the first deploy (e.g. `https://tailormade-api.onrender.com`).

---

## 4. Deploy order

1. Deploy **tailormade-api** first (so you get the URL).
2. Set **tailormade-admin** env var `VITE_API_URL` to `https://<your-api-url>/api`.
3. Deploy **tailormade-admin**.

If you set `VITE_API_URL` before the first admin deploy, you can use the default backend URL Render will assign (e.g. `https://tailormade-api.onrender.com`).

---

## 5. Create the first admin user

Backend uses MongoDB; admins are normal users with `role: 'admin'`.

**Option A – MongoDB Atlas / Compass**

1. Open your MongoDB database.
2. In the `users` collection, insert a document with **username** (required), **password** (bcrypt hash), and optional email:

```json
{
  "username": "admin",
  "email": "admin@yourdomain.com",
  "password": "<bcrypt hash of your password>",
  "name": "Admin",
  "role": "admin",
  "consentTermsAt": { "$date": "2025-01-01T00:00:00.000Z" }
}
```

To generate a bcrypt hash (Node):

```bash
node -e "const bcrypt=require('bcryptjs'); console.log(bcrypt.hashSync('YourPassword', 12));"
```

**Option B – One-off script**

From your machine (with `MONGODB_URI` and bcrypt):

```js
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');
mongoose.connect(process.env.MONGODB_URI).then(async () => {
  await mongoose.connection.db.collection('users').insertOne({
    email: 'admin@yourdomain.com',
    password: bcrypt.hashSync('YourPassword', 12),
    name: 'Admin',
    role: 'admin',
    consentTermsAt: new Date(),
  });
  process.exit(0);
});
```

Then log in on the admin site with that username (or email) and password.

---

## 6. Custom domains (optional)

- **Backend**: Dashboard → tailormade-api → **Settings** → **Custom Domains** (e.g. `api.yourdomain.com`). Update CORS and mobile `EXPO_PUBLIC_API_URL` to this URL.
- **Admin**: Dashboard → tailormade-admin → **Settings** → **Custom Domains** (e.g. `admin.yourdomain.com`). Set backend `ADMIN_WEB_URL` and `FRONTEND_URL` to this URL.

---

## 7. Mobile app

Point the mobile app at the deployed API:

- **Production**: set `EXPO_PUBLIC_API_URL` to `https://tailormade-api.onrender.com/api` (or your custom API URL) in your build env / EAS secrets.

---

## Troubleshooting

- **Admin shows “Network Error” or 401**: Ensure `VITE_API_URL` is exactly the API base URL including `/api`, and that the backend has `ADMIN_WEB_URL` / `FRONTEND_URL` set to the admin origin so CORS allows it.
- **Backend 503 / no start**: Check **Logs** for crashes; ensure `MONGODB_URI` is set and the database is reachable from Render.
- **Static admin 404 on refresh**: The Blueprint includes a rewrite so `/*` → `/index.html`. If you didn’t use the Blueprint, add that rewrite in the static site’s **Redirects/Rewrites** in Render.
